import { map } from 'rxjs';
import { VirtualizedListService } from './virtualized-list.service';
/**
 * The `VirtualizedMessageListService` removes messages from the message list that are currently not in view
 */
export class VirtualizedMessageListService extends VirtualizedListService {
    constructor(mode, scrollPosition$, channelService) {
        const jumpToMessage$ = channelService.jumpToMessage$.pipe(map((jumpToMessage) => {
            let result = {
                item: undefined,
            };
            let targetMessageId;
            if (mode === 'main') {
                targetMessageId = jumpToMessage.parentId
                    ? jumpToMessage.parentId
                    : jumpToMessage.id;
            }
            else {
                targetMessageId = jumpToMessage.parentId
                    ? jumpToMessage.id
                    : undefined;
            }
            if (targetMessageId) {
                const messages = mode === 'main'
                    ? channelService.activeChannelMessages
                    : channelService.activeChannelThreadReplies;
                const id = targetMessageId === 'latest'
                    ? messages[messages.length - 1]?.id
                    : targetMessageId;
                if (id) {
                    result = {
                        item: { id },
                        position: jumpToMessage.id === 'latest' ? 'bottom' : 'middle',
                    };
                }
                channelService.clearMessageJump();
            }
            return result;
        }));
        const messages$ = mode === 'main'
            ? channelService.activeChannelMessages$
            : channelService.activeThreadMessages$;
        super(messages$, scrollPosition$, jumpToMessage$, channelService.messagePageSize);
        this.mode = mode;
        this.channelService = channelService;
        this.isEqual = (t1, t2) => t1.id === t2.id;
        this.query = (direction) => {
            const request = this.mode === 'main'
                ? (direction) => this.channelService.loadMoreMessages(direction)
                : (direction) => this.channelService.loadMoreThreadReplies(direction);
            const result = request(direction === 'top' ? 'older' : 'newer');
            if (result) {
                return result;
            }
            else {
                this.queryStateSubject.next({ state: 'success' });
                if ((direction === 'top' && this.bufferOnTop > 0) ||
                    (direction === 'bottom' && this.bufferOnBottom > 0)) {
                    this.loadFromBuffer$.next();
                }
                return Promise.resolve();
            }
        };
    }
    loadMoreFromBuffer(direction) {
        this.queryStateSubject.next({ state: `loading-${direction}` });
        setTimeout(() => {
            this.loadFromBuffer$.next();
            this.queryStateSubject.next({ state: 'success' });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbGl6ZWQtbWVzc2FnZS1saXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9zdHJlYW0tY2hhdC1hbmd1bGFyL3NyYy9saWIvdmlydHVhbGl6ZWQtbWVzc2FnZS1saXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsT0FBTyxFQUFFLEdBQUcsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVwRTs7R0FFRztBQUNILE1BQU0sT0FBTyw2QkFBOEIsU0FBUSxzQkFBcUM7SUFDdEYsWUFDa0IsSUFBdUIsRUFDdkMsZUFBMEQsRUFDbEQsY0FBOEI7UUFFdEMsTUFBTSxjQUFjLEdBQUcsY0FBYyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQ3ZELEdBQUcsQ0FNRCxDQUFDLGFBQWEsRUFBRSxFQUFFO1lBQ2xCLElBQUksTUFBTSxHQUdOO2dCQUNGLElBQUksRUFBRSxTQUFTO2FBQ2hCLENBQUM7WUFDRixJQUFJLGVBQW1DLENBQUM7WUFDeEMsSUFBSSxJQUFJLEtBQUssTUFBTSxFQUFFO2dCQUNuQixlQUFlLEdBQUcsYUFBYSxDQUFDLFFBQVE7b0JBQ3RDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUTtvQkFDeEIsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7YUFDdEI7aUJBQU07Z0JBQ0wsZUFBZSxHQUFHLGFBQWEsQ0FBQyxRQUFRO29CQUN0QyxDQUFDLENBQUMsYUFBYSxDQUFDLEVBQUU7b0JBQ2xCLENBQUMsQ0FBQyxTQUFTLENBQUM7YUFDZjtZQUVELElBQUksZUFBZSxFQUFFO2dCQUNuQixNQUFNLFFBQVEsR0FDWixJQUFJLEtBQUssTUFBTTtvQkFDYixDQUFDLENBQUMsY0FBYyxDQUFDLHFCQUFxQjtvQkFDdEMsQ0FBQyxDQUFDLGNBQWMsQ0FBQywwQkFBMEIsQ0FBQztnQkFDaEQsTUFBTSxFQUFFLEdBQ04sZUFBZSxLQUFLLFFBQVE7b0JBQzFCLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFO29CQUNuQyxDQUFDLENBQUMsZUFBZSxDQUFDO2dCQUN0QixJQUFJLEVBQUUsRUFBRTtvQkFDTixNQUFNLEdBQUc7d0JBQ1AsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFO3dCQUNaLFFBQVEsRUFBRSxhQUFhLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRO3FCQUM5RCxDQUFDO2lCQUNIO2dCQUNELGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO2FBQ25DO1lBRUQsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUNGLE1BQU0sU0FBUyxHQUNiLElBQUksS0FBSyxNQUFNO1lBQ2IsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxzQkFBc0I7WUFDdkMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQztRQUMzQyxLQUFLLENBQ0gsU0FBUyxFQUNULGVBQWUsRUFDZixjQUFjLEVBQ2QsY0FBYyxDQUFDLGVBQWUsQ0FDL0IsQ0FBQztRQTNEYyxTQUFJLEdBQUosSUFBSSxDQUFtQjtRQUUvQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFvRTlCLFlBQU8sR0FBRyxDQUFDLEVBQWlCLEVBQUUsRUFBaUIsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBRXBFLFVBQUssR0FBRyxDQUFDLFNBQXdDLEVBQUUsRUFBRTtZQUM3RCxNQUFNLE9BQU8sR0FDWCxJQUFJLENBQUMsSUFBSSxLQUFLLE1BQU07Z0JBQ2xCLENBQUMsQ0FBQyxDQUFDLFNBQTRCLEVBQUUsRUFBRSxDQUMvQixJQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQztnQkFDbkQsQ0FBQyxDQUFDLENBQUMsU0FBNEIsRUFBRSxFQUFFLENBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMscUJBQXFCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDN0QsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFNBQVMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEUsSUFBSSxNQUFNLEVBQUU7Z0JBQ1YsT0FBTyxNQUFNLENBQUM7YUFDZjtpQkFBTTtnQkFDTCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7Z0JBQ2xELElBQ0UsQ0FBQyxTQUFTLEtBQUssS0FBSyxJQUFJLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO29CQUM3QyxDQUFDLFNBQVMsS0FBSyxRQUFRLElBQUksSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUMsRUFDbkQ7b0JBQ0EsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztpQkFDN0I7Z0JBQ0QsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7YUFDMUI7UUFDSCxDQUFDLENBQUM7SUFoQ0YsQ0FBQztJQUVTLGtCQUFrQixDQUFDLFNBQXdDO1FBQ25FLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsV0FBVyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDL0QsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDNUIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQXlCRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5uZWxTZXJ2aWNlIH0gZnJvbSAnLi9jaGFubmVsLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgVmlydHVhbGl6ZWRMaXN0UXVlcnlEaXJlY3Rpb24sXG4gIFZpcnR1YWxpemVkTGlzdFNjcm9sbFBvc2l0aW9uLFxuICBTdHJlYW1NZXNzYWdlLFxuICBWaXJ0dWFsaXplZExpc3RWZXJ0aWNhbEl0ZW1Qb3NpdGlvbixcbn0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBtYXAsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFZpcnR1YWxpemVkTGlzdFNlcnZpY2UgfSBmcm9tICcuL3ZpcnR1YWxpemVkLWxpc3Quc2VydmljZSc7XG5cbi8qKlxuICogVGhlIGBWaXJ0dWFsaXplZE1lc3NhZ2VMaXN0U2VydmljZWAgcmVtb3ZlcyBtZXNzYWdlcyBmcm9tIHRoZSBtZXNzYWdlIGxpc3QgdGhhdCBhcmUgY3VycmVudGx5IG5vdCBpbiB2aWV3XG4gKi9cbmV4cG9ydCBjbGFzcyBWaXJ0dWFsaXplZE1lc3NhZ2VMaXN0U2VydmljZSBleHRlbmRzIFZpcnR1YWxpemVkTGlzdFNlcnZpY2U8U3RyZWFtTWVzc2FnZT4ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgbW9kZTogJ3RocmVhZCcgfCAnbWFpbicsXG4gICAgc2Nyb2xsUG9zaXRpb24kOiBPYnNlcnZhYmxlPFZpcnR1YWxpemVkTGlzdFNjcm9sbFBvc2l0aW9uPixcbiAgICBwcml2YXRlIGNoYW5uZWxTZXJ2aWNlOiBDaGFubmVsU2VydmljZVxuICApIHtcbiAgICBjb25zdCBqdW1wVG9NZXNzYWdlJCA9IGNoYW5uZWxTZXJ2aWNlLmp1bXBUb01lc3NhZ2UkLnBpcGUoXG4gICAgICBtYXA8XG4gICAgICAgIHsgaWQ/OiBzdHJpbmc7IHBhcmVudElkPzogc3RyaW5nIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBpdGVtOiBQYXJ0aWFsPFN0cmVhbU1lc3NhZ2U+IHwgdW5kZWZpbmVkO1xuICAgICAgICAgIHBvc2l0aW9uPzogVmlydHVhbGl6ZWRMaXN0VmVydGljYWxJdGVtUG9zaXRpb247XG4gICAgICAgIH1cbiAgICAgID4oKGp1bXBUb01lc3NhZ2UpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDoge1xuICAgICAgICAgIGl0ZW06IFBhcnRpYWw8U3RyZWFtTWVzc2FnZT4gfCB1bmRlZmluZWQ7XG4gICAgICAgICAgcG9zaXRpb24/OiBWaXJ0dWFsaXplZExpc3RWZXJ0aWNhbEl0ZW1Qb3NpdGlvbjtcbiAgICAgICAgfSA9IHtcbiAgICAgICAgICBpdGVtOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICAgIGxldCB0YXJnZXRNZXNzYWdlSWQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKG1vZGUgPT09ICdtYWluJykge1xuICAgICAgICAgIHRhcmdldE1lc3NhZ2VJZCA9IGp1bXBUb01lc3NhZ2UucGFyZW50SWRcbiAgICAgICAgICAgID8ganVtcFRvTWVzc2FnZS5wYXJlbnRJZFxuICAgICAgICAgICAgOiBqdW1wVG9NZXNzYWdlLmlkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRhcmdldE1lc3NhZ2VJZCA9IGp1bXBUb01lc3NhZ2UucGFyZW50SWRcbiAgICAgICAgICAgID8ganVtcFRvTWVzc2FnZS5pZFxuICAgICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGFyZ2V0TWVzc2FnZUlkKSB7XG4gICAgICAgICAgY29uc3QgbWVzc2FnZXMgPVxuICAgICAgICAgICAgbW9kZSA9PT0gJ21haW4nXG4gICAgICAgICAgICAgID8gY2hhbm5lbFNlcnZpY2UuYWN0aXZlQ2hhbm5lbE1lc3NhZ2VzXG4gICAgICAgICAgICAgIDogY2hhbm5lbFNlcnZpY2UuYWN0aXZlQ2hhbm5lbFRocmVhZFJlcGxpZXM7XG4gICAgICAgICAgY29uc3QgaWQgPVxuICAgICAgICAgICAgdGFyZ2V0TWVzc2FnZUlkID09PSAnbGF0ZXN0J1xuICAgICAgICAgICAgICA/IG1lc3NhZ2VzW21lc3NhZ2VzLmxlbmd0aCAtIDFdPy5pZFxuICAgICAgICAgICAgICA6IHRhcmdldE1lc3NhZ2VJZDtcbiAgICAgICAgICBpZiAoaWQpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IHtcbiAgICAgICAgICAgICAgaXRlbTogeyBpZCB9LFxuICAgICAgICAgICAgICBwb3NpdGlvbjoganVtcFRvTWVzc2FnZS5pZCA9PT0gJ2xhdGVzdCcgPyAnYm90dG9tJyA6ICdtaWRkbGUnLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2hhbm5lbFNlcnZpY2UuY2xlYXJNZXNzYWdlSnVtcCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBtZXNzYWdlcyQgPVxuICAgICAgbW9kZSA9PT0gJ21haW4nXG4gICAgICAgID8gY2hhbm5lbFNlcnZpY2UuYWN0aXZlQ2hhbm5lbE1lc3NhZ2VzJFxuICAgICAgICA6IGNoYW5uZWxTZXJ2aWNlLmFjdGl2ZVRocmVhZE1lc3NhZ2VzJDtcbiAgICBzdXBlcihcbiAgICAgIG1lc3NhZ2VzJCxcbiAgICAgIHNjcm9sbFBvc2l0aW9uJCxcbiAgICAgIGp1bXBUb01lc3NhZ2UkLFxuICAgICAgY2hhbm5lbFNlcnZpY2UubWVzc2FnZVBhZ2VTaXplXG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBsb2FkTW9yZUZyb21CdWZmZXIoZGlyZWN0aW9uOiBWaXJ0dWFsaXplZExpc3RRdWVyeURpcmVjdGlvbik6IHZvaWQge1xuICAgIHRoaXMucXVlcnlTdGF0ZVN1YmplY3QubmV4dCh7IHN0YXRlOiBgbG9hZGluZy0ke2RpcmVjdGlvbn1gIH0pO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5sb2FkRnJvbUJ1ZmZlciQubmV4dCgpO1xuICAgICAgdGhpcy5xdWVyeVN0YXRlU3ViamVjdC5uZXh0KHsgc3RhdGU6ICdzdWNjZXNzJyB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBpc0VxdWFsID0gKHQxOiBTdHJlYW1NZXNzYWdlLCB0MjogU3RyZWFtTWVzc2FnZSkgPT4gdDEuaWQgPT09IHQyLmlkO1xuXG4gIHByb3RlY3RlZCBxdWVyeSA9IChkaXJlY3Rpb246IFZpcnR1YWxpemVkTGlzdFF1ZXJ5RGlyZWN0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVxdWVzdCA9XG4gICAgICB0aGlzLm1vZGUgPT09ICdtYWluJ1xuICAgICAgICA/IChkaXJlY3Rpb246ICdvbGRlcicgfCAnbmV3ZXInKSA9PlxuICAgICAgICAgICAgdGhpcy5jaGFubmVsU2VydmljZS5sb2FkTW9yZU1lc3NhZ2VzKGRpcmVjdGlvbilcbiAgICAgICAgOiAoZGlyZWN0aW9uOiAnb2xkZXInIHwgJ25ld2VyJykgPT5cbiAgICAgICAgICAgIHRoaXMuY2hhbm5lbFNlcnZpY2UubG9hZE1vcmVUaHJlYWRSZXBsaWVzKGRpcmVjdGlvbik7XG4gICAgY29uc3QgcmVzdWx0ID0gcmVxdWVzdChkaXJlY3Rpb24gPT09ICd0b3AnID8gJ29sZGVyJyA6ICduZXdlcicpO1xuICAgIGlmIChyZXN1bHQpIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucXVlcnlTdGF0ZVN1YmplY3QubmV4dCh7IHN0YXRlOiAnc3VjY2VzcycgfSk7XG4gICAgICBpZiAoXG4gICAgICAgIChkaXJlY3Rpb24gPT09ICd0b3AnICYmIHRoaXMuYnVmZmVyT25Ub3AgPiAwKSB8fFxuICAgICAgICAoZGlyZWN0aW9uID09PSAnYm90dG9tJyAmJiB0aGlzLmJ1ZmZlck9uQm90dG9tID4gMClcbiAgICAgICkge1xuICAgICAgICB0aGlzLmxvYWRGcm9tQnVmZmVyJC5uZXh0KCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICB9O1xufVxuIl19