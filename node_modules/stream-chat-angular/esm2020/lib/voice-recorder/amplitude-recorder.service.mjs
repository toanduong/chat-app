import { Injectable, NgModule } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "../chat-client.service";
const MAX_FREQUENCY_AMPLITUDE = 255;
const rootMeanSquare = (values) => Math.sqrt(values.reduce((acc, val) => acc + Math.pow(val, 2), 0) / values.length);
export const DEFAULT_AMPLITUDE_RECORDER_CONFIG = {
    analyserConfig: {
        fftSize: 32,
        maxDecibels: 0,
        minDecibels: -100,
    },
    sampleCount: 100,
    samplingFrequencyMs: 60,
};
/**
 * The `AmplitudeRecorderService` is a utility service used to create amplitude values for voice recordings, making it possible to display a wave bar
 */
export class AmplitudeRecorderService {
    constructor(chatService) {
        this.chatService = chatService;
        this.config = DEFAULT_AMPLITUDE_RECORDER_CONFIG;
        this.amplitudesSubject = new BehaviorSubject([]);
        this.errorSubject = new BehaviorSubject(undefined);
        /**
         * Start amplitude recording for the given media stream
         * @param stream
         */
        this.start = (stream) => {
            this.stop();
            this.stream = stream;
            this.init();
            this.resume();
        };
        this.amplitudes$ = this.amplitudesSubject.asObservable();
        this.error$ = this.errorSubject.asObservable();
    }
    /**
     * The recorded amplitudes
     */
    get amplitudes() {
        return this.amplitudesSubject.value;
    }
    /**
     * Temporarily pause amplitude recording, recording can be resumed with `resume`
     */
    pause() {
        clearInterval(this.amplitudeSamplingInterval);
        this.amplitudeSamplingInterval = undefined;
    }
    /**
     * Resume amplited recording after it was pasued
     */
    resume() {
        this.amplitudeSamplingInterval = setInterval(() => {
            if (!this.analyserNode) {
                return;
            }
            const frequencyBins = new Uint8Array(this.analyserNode.frequencyBinCount);
            try {
                this.analyserNode.getByteFrequencyData(frequencyBins);
            }
            catch (e) {
                this.logError(e);
                this.errorSubject.next(e);
                return;
            }
            const normalizedSignalStrength = rootMeanSquare(frequencyBins) / MAX_FREQUENCY_AMPLITUDE;
            this.amplitudesSubject.next([
                ...this.amplitudesSubject.value,
                normalizedSignalStrength,
            ]);
        }, this.config.samplingFrequencyMs);
    }
    /**
     * Stop the amplitude recording and frees up used resources
     */
    stop() {
        if (!this.stream) {
            return;
        }
        this.stream = undefined;
        clearInterval(this.amplitudeSamplingInterval);
        this.amplitudeSamplingInterval = undefined;
        this.amplitudesSubject.next([]);
        this.errorSubject.next(undefined);
        this.microphone?.disconnect();
        this.analyserNode?.disconnect();
        if (this.audioContext?.state !== 'closed') {
            void this.audioContext?.close();
        }
    }
    init() {
        if (!this.stream) {
            return;
        }
        this.audioContext = new AudioContext();
        this.analyserNode = this.audioContext.createAnalyser();
        const { analyserConfig } = this.config;
        this.analyserNode.fftSize = analyserConfig.fftSize;
        this.analyserNode.maxDecibels = analyserConfig.maxDecibels;
        this.analyserNode.minDecibels = analyserConfig.minDecibels;
        this.microphone = this.audioContext.createMediaStreamSource(this.stream);
        this.microphone.connect(this.analyserNode);
    }
    logError(error) {
        this.chatService.chatClient?.logger('error', error.message, {
            error: error,
            tag: ['AmplitudeRecorderService'],
        });
    }
}
AmplitudeRecorderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: AmplitudeRecorderService, deps: [{ token: i1.ChatClientService }], target: i0.ɵɵFactoryTarget.Injectable });
AmplitudeRecorderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: AmplitudeRecorderService, providedIn: NgModule });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: AmplitudeRecorderService, decorators: [{
            type: Injectable,
            args: [{ providedIn: NgModule }]
        }], ctorParameters: function () { return [{ type: i1.ChatClientService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW1wbGl0dWRlLXJlY29yZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zdHJlYW0tY2hhdC1hbmd1bGFyL3NyYy9saWIvdm9pY2UtcmVjb3JkZXIvYW1wbGl0dWRlLXJlY29yZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLE1BQU0sQ0FBQzs7O0FBR25ELE1BQU0sdUJBQXVCLEdBQUcsR0FBWSxDQUFDO0FBRTdDLE1BQU0sY0FBYyxHQUFHLENBQUMsTUFBa0IsRUFBRSxFQUFFLENBQzVDLElBQUksQ0FBQyxJQUFJLENBQ1AsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUN2RSxDQUFDO0FBK0JKLE1BQU0sQ0FBQyxNQUFNLGlDQUFpQyxHQUE0QjtJQUN4RSxjQUFjLEVBQUU7UUFDZCxPQUFPLEVBQUUsRUFBRTtRQUNYLFdBQVcsRUFBRSxDQUFDO1FBQ2QsV0FBVyxFQUFFLENBQUMsR0FBRztLQUNTO0lBQzVCLFdBQVcsRUFBRSxHQUFHO0lBQ2hCLG1CQUFtQixFQUFFLEVBQUU7Q0FDeEIsQ0FBQztBQUVGOztHQUVHO0FBRUgsTUFBTSxPQUFPLHdCQUF3QjtJQWFuQyxZQUFvQixXQUE4QjtRQUE5QixnQkFBVyxHQUFYLFdBQVcsQ0FBbUI7UUFabEQsV0FBTSxHQUFHLGlDQUFpQyxDQUFDO1FBSW5DLHNCQUFpQixHQUFHLElBQUksZUFBZSxDQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELGlCQUFZLEdBQUcsSUFBSSxl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LENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdkQsTUFBTSxFQUFFLGNBQWMsRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDdkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQztRQUNuRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsR0FBRyxjQUFjLENBQUMsV0FBVyxDQUFDO1FBQzNELElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxHQUFHLGNBQWMsQ0FBQyxXQUFXLENBQUM7UUFFM0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN6RSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVPLFFBQVEsQ0FBQyxLQUFZO1FBQzNCLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUMxRCxLQUFLLEVBQUUsS0FBSztZQUNaLEdBQUcsRUFBRSxDQUFDLDBCQUEwQixDQUFDO1NBQ2xDLENBQUMsQ0FBQztJQUNMLENBQUM7O3FIQS9HVSx3QkFBd0I7eUhBQXhCLHdCQUF3QixjQURYLFFBQVE7MkZBQ3JCLHdCQUF3QjtrQkFEcEMsVUFBVTttQkFBQyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ01vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDaGF0Q2xpZW50U2VydmljZSB9IGZyb20gJy4uL2NoYXQtY2xpZW50LnNlcnZpY2UnO1xuXG5jb25zdCBNQVhfRlJFUVVFTkNZX0FNUExJVFVERSA9IDI1NSBhcyBjb25zdDtcblxuY29uc3Qgcm9vdE1lYW5TcXVhcmUgPSAodmFsdWVzOiBVaW50OEFycmF5KSA9PlxuICBNYXRoLnNxcnQoXG4gICAgdmFsdWVzLnJlZHVjZSgoYWNjLCB2YWwpID0+IGFjYyArIE1hdGgucG93KHZhbCwgMiksIDApIC8gdmFsdWVzLmxlbmd0aFxuICApO1xuXG4vKipcbiAqIGZmdFNpemVcbiAqIEFuIHVuc2lnbmVkIGludGVnZXIsIHJlcHJlc2VudGluZyB0aGUgd2luZG93IHNpemUgb2YgdGhlIEZGVCwgZ2l2ZW4gaW4gbnVtYmVyIG9mIHNhbXBsZXMuXG4gKiBBIGhpZ2hlciB2YWx1ZSB3aWxsIHJlc3VsdCBpbiBtb3JlIGRldGFpbHMgaW4gdGhlIGZyZXF1ZW5jeSBkb21haW4gYnV0IGZld2VyIGRldGFpbHNcbiAqIGluIHRoZSBhbXBsaXR1ZGUgZG9tYWluLlxuICpcbiAqIE11c3QgYmUgYSBwb3dlciBvZiAyIGJldHdlZW4gMl41IGFuZCAyXjE1LCBzbyBvbmUgb2Y6IDMyLCA2NCwgMTI4LCAyNTYsIDUxMiwgMTAyNCwgMjA0OCwgNDA5NiwgODE5MiwgMTYzODQsIGFuZCAzMjc2OC5cbiAqIERlZmF1bHRzIHRvIDMyLlxuICpcbiAqIG1heERlY2liZWxzXG4gKiBBIGRvdWJsZSwgcmVwcmVzZW50aW5nIHRoZSBtYXhpbXVtIGRlY2liZWwgdmFsdWUgZm9yIHNjYWxpbmcgdGhlIEZGVCBhbmFseXNpcyBkYXRhLFxuICogd2hlcmUgMCBkQiBpcyB0aGUgbG91ZGVzdCBwb3NzaWJsZSBzb3VuZCwgLTEwIGRCIGlzIGEgMTB0aCBvZiB0aGF0LCBldGMuXG4gKiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAtMzAgZEIuXG4gKlxuICogbWluRGVjaWJlbHNcbiAqIEEgZG91YmxlLCByZXByZXNlbnRpbmcgdGhlIG1pbmltdW0gZGVjaWJlbCB2YWx1ZSBmb3Igc2NhbGluZyB0aGUgRkZUIGFuYWx5c2lzIGRhdGEsXG4gKiB3aGVyZSAwIGRCIGlzIHRoZSBsb3VkZXN0IHBvc3NpYmxlIHNvdW5kLCAtMTAgZEIgaXMgYSAxMHRoIG9mIHRoYXQsIGV0Yy5cbiAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzIC0xMDAgZEIuXG4gKi9cbmV4cG9ydCB0eXBlIEFtcGxpdHVkZUFuYWx5c2VyQ29uZmlnID0gUGljazxcbiAgQW5hbHlzZXJOb2RlLFxuICAnZmZ0U2l6ZScgfCAnbWF4RGVjaWJlbHMnIHwgJ21pbkRlY2liZWxzJ1xuPjtcbmV4cG9ydCB0eXBlIEFtcGxpdHVkZVJlY29yZGVyQ29uZmlnID0ge1xuICBhbmFseXNlckNvbmZpZzogQW1wbGl0dWRlQW5hbHlzZXJDb25maWc7XG4gIHNhbXBsZUNvdW50OiBudW1iZXI7XG4gIHNhbXBsaW5nRnJlcXVlbmN5TXM6IG51bWJlcjtcbn07XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX0FNUExJVFVERV9SRUNPUkRFUl9DT05GSUc6IEFtcGxpdHVkZVJlY29yZGVyQ29uZmlnID0ge1xuICBhbmFseXNlckNvbmZpZzoge1xuICAgIGZmdFNpemU6IDMyLFxuICAgIG1heERlY2liZWxzOiAwLFxuICAgIG1pbkRlY2liZWxzOiAtMTAwLFxuICB9IGFzIEFtcGxpdHVkZUFuYWx5c2VyQ29uZmlnLFxuICBzYW1wbGVDb3VudDogMTAwLFxuICBzYW1wbGluZ0ZyZXF1ZW5jeU1zOiA2MCxcbn07XG5cbi8qKlxuICogVGhlIGBBbXBsaXR1ZGVSZWNvcmRlclNlcnZpY2VgIGlzIGEgdXRpbGl0eSBzZXJ2aWNlIHVzZWQgdG8gY3JlYXRlIGFtcGxpdHVkZSB2YWx1ZXMgZm9yIHZvaWNlIHJlY29yZGluZ3MsIG1ha2luZyBpdCBwb3NzaWJsZSB0byBkaXNwbGF5IGEgd2F2ZSBiYXJcbiAqL1xuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiBOZ01vZHVsZSB9KVxuZXhwb3J0IGNsYXNzIEFtcGxpdHVkZVJlY29yZGVyU2VydmljZSB7XG4gIGNvbmZpZyA9IERFRkFVTFRfQU1QTElUVURFX1JFQ09SREVSX0NPTkZJRztcbiAgYW1wbGl0dWRlcyQ6IE9ic2VydmFibGU8bnVtYmVyW10+O1xuICBlcnJvciQ6IE9ic2VydmFibGU8RXJyb3IgfCB1bmRlZmluZWQ+O1xuXG4gIHByaXZhdGUgYW1wbGl0dWRlc1N1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PG51bWJlcltdPihbXSk7XG4gIHByaXZhdGUgZXJyb3JTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxFcnJvciB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcbiAgcHJpdmF0ZSBhdWRpb0NvbnRleHQ6IEF1ZGlvQ29udGV4dCB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBhbmFseXNlck5vZGU6IEFuYWx5c2VyTm9kZSB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBtaWNyb3Bob25lOiBNZWRpYVN0cmVhbUF1ZGlvU291cmNlTm9kZSB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBzdHJlYW06IE1lZGlhU3RyZWFtIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIGFtcGxpdHVkZVNhbXBsaW5nSW50ZXJ2YWw6IFJldHVyblR5cGU8dHlwZW9mIHNldEludGVydmFsPiB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNoYXRTZXJ2aWNlOiBDaGF0Q2xpZW50U2VydmljZSkge1xuICAgIHRoaXMuYW1wbGl0dWRlcyQgPSB0aGlzLmFtcGxpdHVkZXNTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMuZXJyb3IkID0gdGhpcy5lcnJvclN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICAvKipcbiAgICogVGhlIHJlY29yZGVkIGFtcGxpdHVkZXNcbiAgICovXG4gIGdldCBhbXBsaXR1ZGVzKCkge1xuICAgIHJldHVybiB0aGlzLmFtcGxpdHVkZXNTdWJqZWN0LnZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IGFtcGxpdHVkZSByZWNvcmRpbmcgZm9yIHRoZSBnaXZlbiBtZWRpYSBzdHJlYW1cbiAgICogQHBhcmFtIHN0cmVhbVxuICAgKi9cbiAgc3RhcnQgPSAoc3RyZWFtOiBNZWRpYVN0cmVhbSkgPT4ge1xuICAgIHRoaXMuc3RvcCgpO1xuXG4gICAgdGhpcy5zdHJlYW0gPSBzdHJlYW07XG4gICAgdGhpcy5pbml0KCk7XG5cbiAgICB0aGlzLnJlc3VtZSgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBUZW1wb3JhcmlseSBwYXVzZSBhbXBsaXR1ZGUgcmVjb3JkaW5nLCByZWNvcmRpbmcgY2FuIGJlIHJlc3VtZWQgd2l0aCBgcmVzdW1lYFxuICAgKi9cbiAgcGF1c2UoKSB7XG4gICAgY2xlYXJJbnRlcnZhbCh0aGlzLmFtcGxpdHVkZVNhbXBsaW5nSW50ZXJ2YWwpO1xuICAgIHRoaXMuYW1wbGl0dWRlU2FtcGxpbmdJbnRlcnZhbCA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXN1bWUgYW1wbGl0ZWQgcmVjb3JkaW5nIGFmdGVyIGl0IHdhcyBwYXN1ZWRcbiAgICovXG4gIHJlc3VtZSgpIHtcbiAgICB0aGlzLmFtcGxpdHVkZVNhbXBsaW5nSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMuYW5hbHlzZXJOb2RlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZyZXF1ZW5jeUJpbnMgPSBuZXcgVWludDhBcnJheSh0aGlzLmFuYWx5c2VyTm9kZS5mcmVxdWVuY3lCaW5Db3VudCk7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLmFuYWx5c2VyTm9kZS5nZXRCeXRlRnJlcXVlbmN5RGF0YShmcmVxdWVuY3lCaW5zKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhpcy5sb2dFcnJvcihlIGFzIEVycm9yKTtcbiAgICAgICAgdGhpcy5lcnJvclN1YmplY3QubmV4dChlIGFzIEVycm9yKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3Qgbm9ybWFsaXplZFNpZ25hbFN0cmVuZ3RoID1cbiAgICAgICAgcm9vdE1lYW5TcXVhcmUoZnJlcXVlbmN5QmlucykgLyBNQVhfRlJFUVVFTkNZX0FNUExJVFVERTtcbiAgICAgIHRoaXMuYW1wbGl0dWRlc1N1YmplY3QubmV4dChbXG4gICAgICAgIC4uLnRoaXMuYW1wbGl0dWRlc1N1YmplY3QudmFsdWUsXG4gICAgICAgIG5vcm1hbGl6ZWRTaWduYWxTdHJlbmd0aCxcbiAgICAgIF0pO1xuICAgIH0sIHRoaXMuY29uZmlnLnNhbXBsaW5nRnJlcXVlbmN5TXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgdGhlIGFtcGxpdHVkZSByZWNvcmRpbmcgYW5kIGZyZWVzIHVwIHVzZWQgcmVzb3VyY2VzXG4gICAqL1xuICBzdG9wKCkge1xuICAgIGlmICghdGhpcy5zdHJlYW0pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zdHJlYW0gPSB1bmRlZmluZWQ7XG4gICAgY2xlYXJJbnRlcnZhbCh0aGlzLmFtcGxpdHVkZVNhbXBsaW5nSW50ZXJ2YWwpO1xuICAgIHRoaXMuYW1wbGl0dWRlU2FtcGxpbmdJbnRlcnZhbCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmFtcGxpdHVkZXNTdWJqZWN0Lm5leHQoW10pO1xuICAgIHRoaXMuZXJyb3JTdWJqZWN0Lm5leHQodW5kZWZpbmVkKTtcbiAgICB0aGlzLm1pY3JvcGhvbmU/LmRpc2Nvbm5lY3QoKTtcbiAgICB0aGlzLmFuYWx5c2VyTm9kZT8uZGlzY29ubmVjdCgpO1xuICAgIGlmICh0aGlzLmF1ZGlvQ29udGV4dD8uc3RhdGUgIT09ICdjbG9zZWQnKSB7XG4gICAgICB2b2lkIHRoaXMuYXVkaW9Db250ZXh0Py5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdCgpIHtcbiAgICBpZiAoIXRoaXMuc3RyZWFtKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hdWRpb0NvbnRleHQgPSBuZXcgQXVkaW9Db250ZXh0KCk7XG4gICAgdGhpcy5hbmFseXNlck5vZGUgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVBbmFseXNlcigpO1xuICAgIGNvbnN0IHsgYW5hbHlzZXJDb25maWcgfSA9IHRoaXMuY29uZmlnO1xuICAgIHRoaXMuYW5hbHlzZXJOb2RlLmZmdFNpemUgPSBhbmFseXNlckNvbmZpZy5mZnRTaXplO1xuICAgIHRoaXMuYW5hbHlzZXJOb2RlLm1heERlY2liZWxzID0gYW5hbHlzZXJDb25maWcubWF4RGVjaWJlbHM7XG4gICAgdGhpcy5hbmFseXNlck5vZGUubWluRGVjaWJlbHMgPSBhbmFseXNlckNvbmZpZy5taW5EZWNpYmVscztcblxuICAgIHRoaXMubWljcm9waG9uZSA9IHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZU1lZGlhU3RyZWFtU291cmNlKHRoaXMuc3RyZWFtKTtcbiAgICB0aGlzLm1pY3JvcGhvbmUuY29ubmVjdCh0aGlzLmFuYWx5c2VyTm9kZSk7XG4gIH1cblxuICBwcml2YXRlIGxvZ0Vycm9yKGVycm9yOiBFcnJvcikge1xuICAgIHRoaXMuY2hhdFNlcnZpY2UuY2hhdENsaWVudD8ubG9nZ2VyKCdlcnJvcicsIGVycm9yLm1lc3NhZ2UsIHtcbiAgICAgIGVycm9yOiBlcnJvcixcbiAgICAgIHRhZzogWydBbXBsaXR1ZGVSZWNvcmRlclNlcnZpY2UnXSxcbiAgICB9KTtcbiAgfVxufVxuIl19