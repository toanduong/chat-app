/**
 * This class allows you to make paginated channel query requests.
 */
export class ChannelQuery {
    constructor(chatService, channelService, filters, sort = { last_message_at: -1 }, options = {
        limit: 25,
        state: true,
        presence: true,
        watch: true,
    }) {
        this.chatService = chatService;
        this.channelService = channelService;
        this.filters = filters;
        this.sort = sort;
        this.options = options;
    }
    async query(queryType) {
        if (queryType === 'first-page' || queryType === 'recover-state') {
            this.nextPageConfiguration = undefined;
        }
        const prevChannels = queryType === 'recover-state' ? [] : this.channelService.channels;
        let filters;
        let options;
        if (this.nextPageConfiguration) {
            if (this.nextPageConfiguration.type === 'filter') {
                filters = {
                    ...this.filters,
                    ...this.nextPageConfiguration.paginationFilter,
                };
                options = this.options;
            }
            else {
                options = {
                    ...this.options,
                    offset: this.nextPageConfiguration.offset,
                };
                filters = this.filters;
            }
        }
        else {
            filters = this.filters;
            options = this.options;
        }
        const channels = await this.chatService.chatClient.queryChannels(filters, this.sort || {}, options);
        this.setNextPageConfiguration(channels);
        const currentActiveChannel = this.channelService.activeChannel;
        if (queryType === 'recover-state' &&
            currentActiveChannel &&
            !channels.find((c) => c.cid === currentActiveChannel?.cid)) {
            try {
                await currentActiveChannel.watch();
                channels.unshift(currentActiveChannel);
            }
            catch (error) {
                this.chatService.chatClient.logger('warn', 'Unable to refetch active channel after state recover', error);
            }
        }
        return {
            channels: [...prevChannels, ...channels],
            hasMorePage: channels.length >= this.options.limit,
        };
    }
    setNextPageConfiguration(channelQueryResult) {
        if (this.customPaginator) {
            this.nextPageConfiguration = this.customPaginator(channelQueryResult);
        }
        else {
            this.nextPageConfiguration = {
                type: 'offset',
                offset: (this.nextPageConfiguration?.type === 'offset'
                    ? this.nextPageConfiguration.offset
                    : 0) + channelQueryResult.length,
            };
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbm5lbC1xdWVyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL3N0cmVhbS1jaGF0LWFuZ3VsYXIvc3JjL2xpYi9jaGFubmVsLXF1ZXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWVBOztHQUVHO0FBQ0gsTUFBTSxPQUFPLFlBQVk7SUFhdkIsWUFDVSxXQUFpQyxFQUNqQyxjQUFpQyxFQUNqQyxPQUEwQixFQUMxQixPQUF1QixFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUM5QyxVQUEwQjtRQUNoQyxLQUFLLEVBQUUsRUFBRTtRQUNULEtBQUssRUFBRSxJQUFJO1FBQ1gsUUFBUSxFQUFFLElBQUk7UUFDZCxLQUFLLEVBQUUsSUFBSTtLQUNaO1FBVE8sZ0JBQVcsR0FBWCxXQUFXLENBQXNCO1FBQ2pDLG1CQUFjLEdBQWQsY0FBYyxDQUFtQjtRQUNqQyxZQUFPLEdBQVAsT0FBTyxDQUFtQjtRQUMxQixTQUFJLEdBQUosSUFBSSxDQUEwQztRQUM5QyxZQUFPLEdBQVAsT0FBTyxDQUtkO0lBQ0EsQ0FBQztJQUVKLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBMkI7UUFDckMsSUFBSSxTQUFTLEtBQUssWUFBWSxJQUFJLFNBQVMsS0FBSyxlQUFlLEVBQUU7WUFDL0QsSUFBSSxDQUFDLHFCQUFxQixHQUFHLFNBQVMsQ0FBQztTQUN4QztRQUNELE1BQU0sWUFBWSxHQUNoQixTQUFTLEtBQUssZUFBZSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDO1FBQ3BFLElBQUksT0FBMEIsQ0FBQztRQUMvQixJQUFJLE9BQXVCLENBQUM7UUFDNUIsSUFBSSxJQUFJLENBQUMscUJBQXFCLEVBQUU7WUFDOUIsSUFBSSxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtnQkFDaEQsT0FBTyxHQUFHO29CQUNSLEdBQUcsSUFBSSxDQUFDLE9BQU87b0JBQ2YsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsZ0JBQWdCO2lCQUMvQyxDQUFDO2dCQUNGLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO2FBQ3hCO2lCQUFNO2dCQUNMLE9BQU8sR0FBRztvQkFDUixHQUFHLElBQUksQ0FBQyxPQUFPO29CQUNmLE1BQU0sRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTTtpQkFDMUMsQ0FBQztnQkFDRixPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQzthQUN4QjtTQUNGO2FBQU07WUFDTCxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUN2QixPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztTQUN4QjtRQUNELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUM5RCxPQUFPLEVBQ1AsSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLEVBQ2YsT0FBTyxDQUNSLENBQUM7UUFDRixJQUFJLENBQUMsd0JBQXdCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFeEMsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQztRQUMvRCxJQUNFLFNBQVMsS0FBSyxlQUFlO1lBQzdCLG9CQUFvQjtZQUNwQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssb0JBQW9CLEVBQUUsR0FBRyxDQUFDLEVBQzFEO1lBQ0EsSUFBSTtnQkFDRixNQUFNLG9CQUFvQixDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNuQyxRQUFRLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7YUFDeEM7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDZCxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQ2hDLE1BQU0sRUFDTixzREFBc0QsRUFDdEQsS0FBZ0MsQ0FDakMsQ0FBQzthQUNIO1NBQ0Y7UUFFRCxPQUFPO1lBQ0wsUUFBUSxFQUFFLENBQUMsR0FBRyxZQUFZLEVBQUUsR0FBRyxRQUFRLENBQUM7WUFDeEMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFNO1NBQ3BELENBQUM7SUFDSixDQUFDO0lBRUQsd0JBQXdCLENBQUMsa0JBQWdDO1FBQ3ZELElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN4QixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3ZFO2FBQU07WUFDTCxJQUFJLENBQUMscUJBQXFCLEdBQUc7Z0JBQzNCLElBQUksRUFBRSxRQUFRO2dCQUNkLE1BQU0sRUFDSixDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLEtBQUssUUFBUTtvQkFDNUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNO29CQUNuQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsTUFBTTthQUNyQyxDQUFDO1NBQ0g7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFubmVsLFxuICBDaGFubmVsRmlsdGVycyxcbiAgQ2hhbm5lbE9wdGlvbnMsXG4gIENoYW5uZWxTb3J0LFxufSBmcm9tICdzdHJlYW0tY2hhdCc7XG5pbXBvcnQgeyBDaGFubmVsU2VydmljZSB9IGZyb20gJy4vY2hhbm5lbC5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIENoYW5uZWxRdWVyeVJlc3VsdCxcbiAgQ2hhbm5lbFF1ZXJ5VHlwZSxcbiAgRGVmYXVsdFN0cmVhbUNoYXRHZW5lcmljcyxcbiAgTmV4dFBhZ2VDb25maWd1cmF0aW9uLFxufSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IENoYXRDbGllbnRTZXJ2aWNlIH0gZnJvbSAnLi9jaGF0LWNsaWVudC5zZXJ2aWNlJztcblxuLyoqXG4gKiBUaGlzIGNsYXNzIGFsbG93cyB5b3UgdG8gbWFrZSBwYWdpbmF0ZWQgY2hhbm5lbCBxdWVyeSByZXF1ZXN0cy5cbiAqL1xuZXhwb3J0IGNsYXNzIENoYW5uZWxRdWVyeTxcbiAgVCBleHRlbmRzIERlZmF1bHRTdHJlYW1DaGF0R2VuZXJpY3MgPSBEZWZhdWx0U3RyZWFtQ2hhdEdlbmVyaWNzXG4+IHtcbiAgLyoqXG4gICAqIEJ5IGRlZmF1bHQgdGhlIFNESyB1c2VzIGFuIG9mZnNldCBiYXNlZCBwYWdpbmF0aW9uLCB5b3UgY2FuIGNoYW5nZS9leHRlbmQgdGhpcyBieSBwcm92aWRpbmcgeW91ciBvd24gY3VzdG9tIHBhZ2luYXRvciBtZXRob2QuXG4gICAqXG4gICAqIFRoZSBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcmVzdWx0IG9mIHRoZSBsYXRlc3QgY2hhbm5lbCBxdWVyeS5cbiAgICpcbiAgICogWW91IGNhbiByZXR1cm4gZWl0aGVyIGFuIG9mZnNldCwgb3IgYSBmaWx0ZXIgdXNpbmcgdGhlIFtgJGx0ZWAvYCRndGVgIG9wZXJhdG9yXSgvY2hhdC9kb2NzL2phdmFzY3JpcHQvcXVlcnlfc3ludGF4X29wZXJhdG9ycy8pLiBJZiB5b3UgcmV0dXJuIGEgZmlsdGVyLCBpdCB3aWxsIGJlIG1lcmdlZCB3aXRoIHRoZSBmaWx0ZXIgcHJvdmlkZWQgZm9yIHRoZSBgaW5pdGAgbWV0aG9kLlxuICAgKi9cbiAgY3VzdG9tUGFnaW5hdG9yPzogKGNoYW5uZWxRdWVyeVJlc3VsdDogQ2hhbm5lbDxUPltdKSA9PiBOZXh0UGFnZUNvbmZpZ3VyYXRpb247XG4gIHByaXZhdGUgbmV4dFBhZ2VDb25maWd1cmF0aW9uPzogTmV4dFBhZ2VDb25maWd1cmF0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY2hhdFNlcnZpY2U6IENoYXRDbGllbnRTZXJ2aWNlPFQ+LFxuICAgIHByaXZhdGUgY2hhbm5lbFNlcnZpY2U6IENoYW5uZWxTZXJ2aWNlPFQ+LFxuICAgIHByaXZhdGUgZmlsdGVyczogQ2hhbm5lbEZpbHRlcnM8VD4sXG4gICAgcHJpdmF0ZSBzb3J0OiBDaGFubmVsU29ydDxUPiA9IHsgbGFzdF9tZXNzYWdlX2F0OiAtMSB9LFxuICAgIHByaXZhdGUgb3B0aW9uczogQ2hhbm5lbE9wdGlvbnMgPSB7XG4gICAgICBsaW1pdDogMjUsXG4gICAgICBzdGF0ZTogdHJ1ZSxcbiAgICAgIHByZXNlbmNlOiB0cnVlLFxuICAgICAgd2F0Y2g6IHRydWUsXG4gICAgfVxuICApIHt9XG5cbiAgYXN5bmMgcXVlcnkocXVlcnlUeXBlOiBDaGFubmVsUXVlcnlUeXBlKTogUHJvbWlzZTxDaGFubmVsUXVlcnlSZXN1bHQ8VD4+IHtcbiAgICBpZiAocXVlcnlUeXBlID09PSAnZmlyc3QtcGFnZScgfHwgcXVlcnlUeXBlID09PSAncmVjb3Zlci1zdGF0ZScpIHtcbiAgICAgIHRoaXMubmV4dFBhZ2VDb25maWd1cmF0aW9uID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCBwcmV2Q2hhbm5lbHMgPVxuICAgICAgcXVlcnlUeXBlID09PSAncmVjb3Zlci1zdGF0ZScgPyBbXSA6IHRoaXMuY2hhbm5lbFNlcnZpY2UuY2hhbm5lbHM7XG4gICAgbGV0IGZpbHRlcnM6IENoYW5uZWxGaWx0ZXJzPFQ+O1xuICAgIGxldCBvcHRpb25zOiBDaGFubmVsT3B0aW9ucztcbiAgICBpZiAodGhpcy5uZXh0UGFnZUNvbmZpZ3VyYXRpb24pIHtcbiAgICAgIGlmICh0aGlzLm5leHRQYWdlQ29uZmlndXJhdGlvbi50eXBlID09PSAnZmlsdGVyJykge1xuICAgICAgICBmaWx0ZXJzID0ge1xuICAgICAgICAgIC4uLnRoaXMuZmlsdGVycyxcbiAgICAgICAgICAuLi50aGlzLm5leHRQYWdlQ29uZmlndXJhdGlvbi5wYWdpbmF0aW9uRmlsdGVyLFxuICAgICAgICB9O1xuICAgICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICAuLi50aGlzLm9wdGlvbnMsXG4gICAgICAgICAgb2Zmc2V0OiB0aGlzLm5leHRQYWdlQ29uZmlndXJhdGlvbi5vZmZzZXQsXG4gICAgICAgIH07XG4gICAgICAgIGZpbHRlcnMgPSB0aGlzLmZpbHRlcnM7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZpbHRlcnMgPSB0aGlzLmZpbHRlcnM7XG4gICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zO1xuICAgIH1cbiAgICBjb25zdCBjaGFubmVscyA9IGF3YWl0IHRoaXMuY2hhdFNlcnZpY2UuY2hhdENsaWVudC5xdWVyeUNoYW5uZWxzKFxuICAgICAgZmlsdGVycyxcbiAgICAgIHRoaXMuc29ydCB8fCB7fSxcbiAgICAgIG9wdGlvbnNcbiAgICApO1xuICAgIHRoaXMuc2V0TmV4dFBhZ2VDb25maWd1cmF0aW9uKGNoYW5uZWxzKTtcblxuICAgIGNvbnN0IGN1cnJlbnRBY3RpdmVDaGFubmVsID0gdGhpcy5jaGFubmVsU2VydmljZS5hY3RpdmVDaGFubmVsO1xuICAgIGlmIChcbiAgICAgIHF1ZXJ5VHlwZSA9PT0gJ3JlY292ZXItc3RhdGUnICYmXG4gICAgICBjdXJyZW50QWN0aXZlQ2hhbm5lbCAmJlxuICAgICAgIWNoYW5uZWxzLmZpbmQoKGMpID0+IGMuY2lkID09PSBjdXJyZW50QWN0aXZlQ2hhbm5lbD8uY2lkKVxuICAgICkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgY3VycmVudEFjdGl2ZUNoYW5uZWwud2F0Y2goKTtcbiAgICAgICAgY2hhbm5lbHMudW5zaGlmdChjdXJyZW50QWN0aXZlQ2hhbm5lbCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmNoYXRTZXJ2aWNlLmNoYXRDbGllbnQubG9nZ2VyKFxuICAgICAgICAgICd3YXJuJyxcbiAgICAgICAgICAnVW5hYmxlIHRvIHJlZmV0Y2ggYWN0aXZlIGNoYW5uZWwgYWZ0ZXIgc3RhdGUgcmVjb3ZlcicsXG4gICAgICAgICAgZXJyb3IgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj5cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgY2hhbm5lbHM6IFsuLi5wcmV2Q2hhbm5lbHMsIC4uLmNoYW5uZWxzXSxcbiAgICAgIGhhc01vcmVQYWdlOiBjaGFubmVscy5sZW5ndGggPj0gdGhpcy5vcHRpb25zLmxpbWl0ISxcbiAgICB9O1xuICB9XG5cbiAgc2V0TmV4dFBhZ2VDb25maWd1cmF0aW9uKGNoYW5uZWxRdWVyeVJlc3VsdDogQ2hhbm5lbDxUPltdKSB7XG4gICAgaWYgKHRoaXMuY3VzdG9tUGFnaW5hdG9yKSB7XG4gICAgICB0aGlzLm5leHRQYWdlQ29uZmlndXJhdGlvbiA9IHRoaXMuY3VzdG9tUGFnaW5hdG9yKGNoYW5uZWxRdWVyeVJlc3VsdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubmV4dFBhZ2VDb25maWd1cmF0aW9uID0ge1xuICAgICAgICB0eXBlOiAnb2Zmc2V0JyxcbiAgICAgICAgb2Zmc2V0OlxuICAgICAgICAgICh0aGlzLm5leHRQYWdlQ29uZmlndXJhdGlvbj8udHlwZSA9PT0gJ29mZnNldCdcbiAgICAgICAgICAgID8gdGhpcy5uZXh0UGFnZUNvbmZpZ3VyYXRpb24ub2Zmc2V0XG4gICAgICAgICAgICA6IDApICsgY2hhbm5lbFF1ZXJ5UmVzdWx0Lmxlbmd0aCxcbiAgICAgIH07XG4gICAgfVxuICB9XG59XG4iXX0=